= üìä Taller Pr√°ctico de Kafka con Datos de CoinGecko (30 minutos)
Viktor Gamov <vgamov@confluent.io>, ¬© 2025 Confluent, Inc.
2025-09-11
:revdate: 2025-09-11
:linkattrs:
:ast: &ast;
:y: &#10003;
:n: &#10008;
:y: icon:check-sign[role="green"]
:n: icon:check-minus[role="red"]
:c: icon:file-text-alt[role="blue"]
:toc: auto
:toc-placement: auto
:toc-position: auto
:toc-title: Contenido de la Gu√≠a de Kafka
:toclevels: 3
:idprefix:
:idseparator: -
:sectanchors:
:icons: font
:source-highlighter: highlight.js
:highlightjs-theme: idea
:experimental:

Esta gu√≠a demuestra la gesti√≥n de t√≥picos de Kafka y el streaming de datos en tiempo real utilizando datos de precios de criptomonedas de la API de CoinGecko.

toc::[]

== üéØ Objetivos de Aprendizaje

Al final de esta secci√≥n, habr√°s:

* ‚úÖ Creado t√≥picos de Kafka con diferentes configuraciones.
* ‚úÖ Configurado un Conector de Origen HTTP (HTTP Source Connector) para obtener datos de criptomonedas en vivo.
* ‚úÖ Monitoreado el streaming de datos de precios en tiempo real.
* ‚úÖ Consumido datos de criptomonedas utilizando la Extensi√≥n de Confluent para VS Code.

== ‚è±Ô∏è Distribuci√≥n del Tiempo

* **Gesti√≥n de T√≥picos**: 10 minutos
* **Configuraci√≥n del Conector de Origen HTTP**: 5 minutos
* **Operaciones de Productor**: 5 minutos
* **Operaciones de Consumidor**: 10 minutos

== üìã Gesti√≥n de T√≥picos (10 minutos)

=== Crear T√≥picos del Taller

[source,bash]
----
# Crear un t√≥pico para los precios de las criptomonedas
confluent kafka topic create crypto-prices \
  --partitions 3 \
  --config retention.ms=604800000 \
  --config cleanup.policy=delete

# Crear un t√≥pico para alertas de precios (menor retenci√≥n)
confluent kafka topic create price-alerts \
  --partitions 1 \
  --config retention.ms=86400000 \
  --config cleanup.policy=delete

# Crear un t√≥pico compactado para los √∫ltimos precios
confluent kafka topic create latest-prices \
  --partitions 3 \
  --config cleanup.policy=compact \
  --config min.cleanable.dirty.ratio=0.01
----

=== Verificar la Configuraci√≥n del T√≥pico

[source,bash]
----
# Listar todos los t√≥picos
confluent kafka topic list

# Describir el t√≥pico crypto-prices
confluent kafka topic describe crypto-prices

# Listar las configuraciones del t√≥pico
confluent kafka topic configuration list crypto-prices
----

=== Mejores Pr√°cticas de Configuraci√≥n de T√≥picos

[source,bash]
----
# Actualizar la configuraci√≥n de un t√≥pico (ejemplo: aumentar la retenci√≥n)
confluent kafka topic update crypto-prices \
  --config retention.ms=1209600000

# Ver la configuraci√≥n actualizada
confluent kafka topic configuration list crypto-prices
----

== üîå Configuraci√≥n del Conector de Origen HTTP (5 minutos)

=== Configurar Variables de Entorno

Primero, configura tus credenciales de API:

[source,bash]
----
# Navegar al directorio de scripts
cd ./scripts/kafka

# Copiar el archivo de entorno de ejemplo y configurar tus claves de API
cp .env.example .env

# Editar el archivo .env con tus claves de API reales:
# export KAFKA_API_KEY="tu-clave-api-kafka"
# export KAFKA_API_SECRET="tu-secreto-api-kafka"
# export SCHEMA_REGISTRY_API_KEY="tu-clave-api-schema-registry"
# export SCHEMA_REGISTRY_API_SECRET="tu-secreto-api-schema-registry"

# Cargar las variables de entorno
source .env
----

=== Desplegar el Conector

[source,bash]
----
# Desplegar el Conector de Origen HTTP usando el script de despliegue
./deploy-connector.sh

# El script har√° lo siguiente:
# - Cargar las variables de entorno desde .env
# - Crear la configuraci√≥n del conector con los ajustes de la API de CoinGecko
# - Desplegar el conector coingecko-price-connector
# - Verificar que el despliegue fue exitoso
----

=== Validar el Estado del Conector

[source,bash]
----
# Comprobar el estado y la salud del conector
./validate-connector.sh

# Esto mostrar√°:
# - Lista de todos los conectores
# - ID y estado del conector
# - Validaci√≥n de la conexi√≥n
----

== üîç Datos del T√≥pico (5 minutos)

=== Entender la Estructura del Mensaje Mejorado

La API de CoinGecko devuelve datos enriquecidos con informaci√≥n de capitalizaci√≥n de mercado y volumen:
[source,json]
----
{
  "bitcoin": {
    "usd": 45000.50,
    "usd_market_cap": 850000000000,
    "usd_24h_vol": 25000000000,
    "usd_24h_change": 2.34,
    "last_updated_at": 1640995200
  },
  "ethereum": {
    "usd": 3500.75,
    "usd_market_cap": 420000000000,
    "usd_24h_vol": 15000000000,
    "usd_24h_change": -1.23,
    "last_updated_at": 1640995200
  },
  "binancecoin": {
    "usd": 450.25,
    "usd_market_cap": 67000000000,
    "usd_24h_vol": 2000000000,
    "usd_24h_change": 1.85,
    "last_updated_at": 1640995200
  }
}
----

== üë• Operaciones de Consumidor (10 minutos)

=== Consumo Visual de Datos con VS Code

La mejor manera de consumir y visualizar los datos de criptomonedas es usando la Extensi√≥n de Confluent para Visual Studio Code.

=== Usando la Extensi√≥n de Confluent para VS Code

1.  **Instalar la Extensi√≥n**: Busca "Confluent" en el mercado de Extensiones de VS Code.
2.  **Conectar a Confluent Cloud**: Usa tu nombre de usuario y contrase√±a de Confluent Cloud.
3.  **Explorar T√≥picos**: Navega hasta el t√≥pico `crypto-prices`.
4.  **Consumir Mensajes**: Haz clic en el t√≥pico para comenzar a consumir mensajes visualmente.

image::../images/crypto-prices-vscode.png[Precios de criptomonedas en VS Code,800,600]

La extensi√≥n de VS Code proporciona:

*   **Visualizaci√≥n de mensajes en tiempo real** con resaltado de sintaxis.
*   **Integraci√≥n con esquemas AVRO** para una deserializaci√≥n correcta.
*   Capacidades de **filtrado y b√∫squeda de mensajes**.
*   **Gesti√≥n de offsets** a trav√©s de la interfaz de usuario.
*   **Monitoreo de grupos de consumidores** con m√©tricas de lag.

== ‚úÖ Lista de Verificaci√≥n

Antes de pasar a la siguiente secci√≥n, aseg√∫rate de que:

- [ ] Se han creado tres t√≥picos con diferentes configuraciones.
- [ ] El Conector de Origen HTTP se ha desplegado usando `./deploy-connector.sh`.
- [ ] El estado del conector se ha validado usando `./validate-connector.sh`.
- [ ] Los datos de criptomonedas en tiempo real fluyen hacia el t√≥pico `crypto-prices`.
- [ ] Has consumido mensajes exitosamente usando la Extensi√≥n de Confluent para VS Code.
- [ ] El consumo visual de datos funciona con la deserializaci√≥n AVRO correcta.
- [ ] Las variables de entorno est√°n configuradas correctamente en el archivo `.env`.

== üîß Entregables Clave

Al final de esta secci√≥n, deber√≠as tener:

*   **M√∫ltiples t√≥picos** con diferentes pol√≠ticas de retenci√≥n y limpieza.
*   Un **Conector de Origen HTTP** que transmite datos de precios de CoinGecko en vivo cada 60 segundos en formato AVRO.
*   **Grupos de consumidores** que consumen activamente datos de criptomonedas en tiempo real.
*   **Comprensi√≥n** de la ingesta de datos basada en conectores y la gesti√≥n de offsets.

== üö® Soluci√≥n de Problemas

=== Problemas con el Conector

**El conector no se inicia**::
[source,bash]
----
# Usa el script de validaci√≥n para comprobar el estado del conector
./validate-connector.sh

# Problemas comunes:
# - Clave/secreto de API inv√°lidos en el archivo .env
# - Conectividad de red
# - Limitaci√≥n de tasa (rate limiting) por parte de la API de CoinGecko
# - Variables de entorno faltantes
----

**No fluyen datos**::
[source,bash]
----
# Comprueba el estado del conector usando el script
./validate-connector.sh

# Verifica que el t√≥pico existe y tiene los permisos correctos
confluent kafka topic describe crypto-prices

# Comprueba si el archivo .env est√° configurado correctamente
source .env && echo "KAFKA_API_KEY: $KAFKA_API_KEY"
----

== üìö Recursos Adicionales

* https://docs.confluent.io/cloud/current/connectors/cc-http-source.html[Documentaci√≥n del Conector de Origen HTTP]
* https://docs.confluent.io/confluent-cli/current/command-reference/kafka/topic/[Referencia del CLI para T√≥picos de Kafka]
* https://www.coingecko.com/en/api/documentation[Documentaci√≥n de la API de CoinGecko]

---

**Siguiente**: Procede a link:03-tableflow-iceberg-setup.adoc[] para la materializaci√≥n con Tableflow y la integraci√≥n con DuckDB.
